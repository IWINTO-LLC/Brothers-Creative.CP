<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="brother_admin_panel">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>brother_admin_panel</title>
  <link rel="manifest" href="manifest.json">

  <!-- Preload fonts to avoid fetch errors -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Firebase Configuration for OTP -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <!-- reCAPTCHA v2 for Phone Authentication -->
  <script src="https://www.google.com/recaptcha/api.js?render=explicit&onload=onRecaptchaLoad"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD9UQWdfrV9oWjMYsGjqD8ToxRK-Jx0IxQ",
      authDomain: "brothers-creative.firebaseapp.com",
      projectId: "brothers-creative",
      storageBucket: "brothers-creative.appspot.com",
      messagingSenderId: "9527223797",
      appId: "1:9527223797:web:7ff0fec7a325c921996cbc"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Global reCAPTCHA verifier
    let recaptchaVerifier = null;
    let recaptchaWidgetId = null;
    let isRecaptchaReady = false;
    
    // Callback when reCAPTCHA loads
    window.onRecaptchaLoad = function() {
      console.log('reCAPTCHA API loaded');
      isRecaptchaReady = true;
      // Wait for DOM to be ready before initializing
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeRecaptcha);
      } else {
        initializeRecaptcha();
      }
    };
    
    // Initialize reCAPTCHA when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      if (isRecaptchaReady) {
        initializeRecaptcha();
      }
    });
    
    function initializeRecaptcha() {
      try {
        // Check if container exists
        const container = document.getElementById('recaptcha-container');
        if (!container) {
          console.error('reCAPTCHA container not found');
          setTimeout(initializeRecaptcha, 1000);
          return;
        }
        
        // Clear any existing verifier
        if (recaptchaVerifier) {
          try {
            recaptchaVerifier.clear();
          } catch (e) {
            console.log('Error clearing existing reCAPTCHA:', e);
          }
        }
        
        // Create new reCAPTCHA verifier
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          'size': 'invisible',
          'callback': function(response) {
            console.log('reCAPTCHA solved:', response);
            window.recaptchaResponse = response;
          },
          'expired-callback': function() {
            console.log('reCAPTCHA expired');
            window.recaptchaResponse = null;
            resetRecaptcha();
          },
          'error-callback': function(error) {
            console.log('reCAPTCHA error:', error);
            window.recaptchaResponse = null;
            resetRecaptcha();
          }
        });
        
        // Render reCAPTCHA
        recaptchaVerifier.render().then(function(widgetId) {
          recaptchaWidgetId = widgetId;
          window.recaptchaVerifier = recaptchaVerifier;
          console.log('reCAPTCHA rendered successfully with widget ID:', widgetId);
        }).catch(function(error) {
          console.error('reCAPTCHA render error:', error);
          // Retry after a short delay with exponential backoff
          setTimeout(initializeRecaptcha, Math.min(5000, 2000 * Math.pow(2, 3)));
        });
        
      } catch (error) {
        console.error('reCAPTCHA initialization error:', error);
        // Retry after a short delay with exponential backoff
        setTimeout(initializeRecaptcha, Math.min(5000, 2000 * Math.pow(2, 3)));
      }
    }
    
    // Function to reset reCAPTCHA
    function resetRecaptcha() {
      try {
        if (recaptchaVerifier) {
          recaptchaVerifier.clear();
        }
        recaptchaVerifier = null;
        recaptchaWidgetId = null;
        window.recaptchaResponse = null;
        setTimeout(initializeRecaptcha, 1000);
      } catch (error) {
        console.error('Error resetting reCAPTCHA:', error);
        setTimeout(initializeRecaptcha, 2000);
      }
    }
    
    // Fallback if reCAPTCHA doesn't load within 10 seconds
    setTimeout(function() {
      if (!isRecaptchaReady) {
        console.warn('reCAPTCHA failed to load within 10 seconds, initializing fallback...');
        initializeRecaptcha();
      }
    }, 10000);
    
    // Additional fallback for cases where reCAPTCHA API fails to load
    setTimeout(function() {
      if (!window.grecaptcha && !isRecaptchaReady) {
        console.error('reCAPTCHA API failed to load completely');
        // Try to reload the reCAPTCHA script
        const script = document.createElement('script');
        script.src = 'https://www.google.com/recaptcha/api.js?render=explicit&onload=onRecaptchaLoad';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }
    }, 15000);
    
    // Make functions globally available
    window.resetRecaptcha = resetRecaptcha;
    window.initializeRecaptcha = initializeRecaptcha;
    window.isRecaptchaReady = function() { return isRecaptchaReady; };
  </script>
</head>
<body>
  <!-- reCAPTCHA container for Phone Authentication -->
  <div id="recaptcha-container"></div>
  
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
